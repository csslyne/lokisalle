<?php
require_once("../inc/init.inc.php");
//Je restreins l'accès au personne connecté avec le statut administrateur
if(!connexionAdmin())
{
  header("location:../connexion.php");
  exit();
}

//Je gére la suppression des promos dans la Bdd.
if(isset($_GET['action']) && $_GET['action'] == "suppression")
{
  $resultat = executeRequete("SELECT * FROM promotion WHERE id_promo='$_GET[id_promo]'");
  $produit_a_supprimer = $resultat->fetch_assoc();
  executeRequete("DELETE FROM promotion WHERE id_promo=$_GET[id_promo]");
   $contenu .= '<div class="validation">Suppression du cote promo : ' . $_GET['id_promo'] .'</div>';
  $_GET['action'] = 'affichage';
}


//Bouton Ajouter
$contenu .= '<a href="?action=ajout">Ajouter un code promo</a><br />';
//Bouton Affichage
$contenu .= '<a href="?action=affichage">Affichage des code promo</a><br /><br/><hr /><br />';


//Je gére l'enregistrement des code promo dans la bdd
if(!empty($_POST))
{
	//J'empêche les injections dans la base de données
  foreach($_POST as $indice => $valeur)
  {
    $_POST[$indice] = htmlentities(addSlashes($valeur));
  }
	executeRequete("REPLACE INTO promotion(id_promo, code_promo, reduction) VALUES ('$_POST[id_promo]','$_POST[code_promo]', '$_POST[reduction]')");	
}

if(isset($_GET['action']) && $_GET['action'] == "affichage" )
{
    $resultat = executeRequete("SELECT * FROM promotion");
    $contenu .= '<h2>Affichage des promos<h2>';
    $contenu .= 'Nombre de promo(s) : ' . $resultat->num_rows;
    $contenu .= '<table border="2" cellpadding="5"><tr>';

	
	while($colonne = $resultat->fetch_field())
    {
      $contenu .= '<th>' .$colonne->name . '</th>';
    }
		
    $contenu .= '<th>Modification</th>';
    $contenu .= '<th>Suppression</th>';
	

    $contenu .= '</tr>';

    while($ligne = $resultat->fetch_assoc())
    {
      $contenu .= '<tr>';
      foreach($ligne as $indice => $information)
      {
        $contenu .= '<td>'.$information.'</td>';
      }
			
      $contenu .= '<td><a href="?action=modification&id_promo='.$ligne['id_promo'] .'"><img src="../inc/img/modif.png" /></a></td>';
      $contenu .= '<td><a href="?action=suppression&id_promo='.$ligne['id_promo'] .'"><img src="../inc/img/supp.png" /></a></td>';

      $contenu .= '</tr>';
    }
    $contenu .= '</table><br /><hr /><br />';
}

//J'ajoute le header et le menu du site.
require_once("../inc/haut.inc.php");
require_once("../inc/menu.inc.php");
//J'ajoute la partie ou est stocké le contenu du site.
echo $contenu;

//Formulaire pour ajouter un code promo.
//Dans les "value" je récupére les données des code promo, pour les auto remplir dans le formulaire quand on souhaite modifier les code promo. 

if(isset($_GET['action']) && ($_GET['action'] == 'ajout' || $_GET['action'] == 'modification'))
{

    if(isset($_GET['id_promo']))
    {
      $resultat = executeRequete("SELECT * FROM promotion WHERE id_promo=$_GET[id_promo]");
      $promo_actuel = $resultat->fetch_assoc();
    }


echo '
<h1>Ajouter un promo</h1><br />
<form method="post" action="">

<input type="hidden" id="id_promo" name="id_promo" value="';if(isset($promo_actuel['id_promo'])) echo $promo_actuel['id_promo']; echo ' "/>

<label for="code_promo">Code promotion</label><br />
<input type="text" id="code_promo" name="code_promo" value="';if(isset($promo_actuel['code_promo'])) echo $promo_actuel['code_promo']; echo '"><br /><br />


<label for="reduction">Reduction</label><br />
<input type="type" id="reduction" name="reduction" value="';if(isset($promo_actuel['reduction'])) echo $promo_actuel['reduction']; echo '"/><br /><br />

<input type="submit" id="envoie" name="envoie" value="inserer"/>

</form>';

}
//J'ajoute le footer du site.
require_once("../inc/bas.inc.php");
?>
